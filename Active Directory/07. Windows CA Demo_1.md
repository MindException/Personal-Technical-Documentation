# Windows Certificate Authority Demo 1

이 번 문서에는 2 계층의 CA 구조로 PKI 환경을 구성합니다.  
* Root CA: workgroup 서버로 추후 설정 후에는 서버를 오프라인으로 유지합니다  
    * 위와 같이 Root CA를 오프라인으로 유지하는 이유는 Root CA의 개인키를 보호하기 위함입니다.  
* Issue CA: Domain에 가입된 서버로 중간 인증 및 인증서 발급 역할을 진행합니다.

## 목차

1. [CAPolicy.inf 편집 및 설정](#1-capolicyinf)
2. [RootCA 구성](#2-root-ca-구성)
3. [CDP & AIA 설정](#3-root-ca-cdp-및-aia-설정)
4. [DNS 추가](#4-dnsad-dc에-root-ca-정보-추가)
5. [내용정리](#5-내용-정리)

<br>

## 1. CAPolicy.inf
* Reference: [https://learn.microsoft.com/ko-kr/windows-server/networking/core-network-guide/cncg/server-certs/prepare-the-capolicy-inf-file](https://learn.microsoft.com/ko-kr/windows-server/networking/core-network-guide/cncg/server-certs/prepare-the-capolicy-inf-file)

<br>

![](./MD_Images/07_00001.jpg)  
```
[Version]
Signature="$Windows NT$"
[PolicyStatementExtension]
Policies=InternalPolicy
[InternalPolicy]
OID=1.3.6.1.4.1.20250922.1
Notice="LSHCorp 사내용 PKI"
URL=https://pki.LSHCorp.com/pki/cps.txt
[Certsrv_Server]
RenewalKeyLength=4096
RenewalValidityPeriod=Years
RenewalValidityPeriodUnits=20
CRLPeriod=Years
CRLPeriodUnits=1
CRLOverlapPeriod=Days
CRLOverlapUnits=3
LoadDefaultTemplates=0
AlternateSignatureAlgorithm=1
[CRLDistributionPoint]
[AuthorityInformationAccess]
```
* 위 코드를 `CAPolicy.inf` 파일로 만든 후, C:\Windows 하위에 저장합니다.
* notepad로 저장할 때, `모든 파일` 형식과 `ANSI` 타입으로 인코딩합니다.

<br>

위 설정 값에 대한 설명은 아래와 같습니다.

![](./MD_Images/07_00002.jpg)

```
[Version]
Signature="$Windows NT$"
[PolicyStatementExtension]
Policies=InternalPolicy
[InternalPolicy]
OID=1.3.6.1.4.1.20250922.1
Notice="LSHCopr 사내용 PKI"
URL=https://pki.LSHCorp.com/pki/cps.txt
```
* 인증서가 사설용이라는 일종의 설명서이다.
* `OID`는 실제로 발급 받아야하며, 기업용 Private Enterprise Number (PEN)은 대부분 `1.3.6.1.4.1.<기업번호>`를 사용하기 때문에 뒤에 임의 숫자를 넣은 후, `1.3.6.1.4.1.<기업번호>.1`로 만듭니다.
* `Notice`는 해당 인증서의 발급자에 대한 설명에 들어갑니다.
* `URL`은 해당 발급 기관에 대한 설명 문서를 다운받을 수 있는 링크입니다.  

<br>

```
[Certsrv_Server]
RenewalKeyLength=4096
RenewalValidityPeriod=Years
RenewalValidityPeriodUnits=20
CRLPeriod=Years
CRLPeriodUnits=1
CRLOverlapPeriod=Days
CRLOverlapUnits=3
```
* 우선적으로 `Renewal` 값은 최초 인증서 발급이 아닌 인증서 갱신 때 적용되는 설정값입니다.
    * 전체적인 내용을 설명하면 암호화는 4096으로 변경하고 갱신할 때는 20년으로 갱신한다는 설정값입니다.
    * 만약 신규 CA 설치 때, 신규 인증서 발급 기간보다 갱신 기간을 적게 설정한다면 적용되지 않고, CA 루트 인증서 발급 기간에 맞추어 생성됩니다.

* 그 다음 CRL(인증서 폐기 목록) 설정은 기본적으로 매우 짧게 설정되어 Root CA의 경우 길게 다시 변경합니다.
    * 전체적인 CRL 발급 주기에 대한 설명하면 1년마다 crl 파일은 폐기되며, 폐기 되기 3일 전에 자동으로 신규 crl이 생성됩니다.

<br>

```
LoadDefaultTemplates=0
AlternateSignatureAlgorithm=1
[CRLDistributionPoint]
[AuthorityInformationAccess]
```
* `LoadDefaultTemplates`: RootCA이기 때문에 기본 Template들을 로드하지 않습니다.
* `AlternateSignatureAlgorithm`: 해당 값을 `1`로 설정하여 강화된 최신 서명 알고리즘 사용합니다.(SHA256 이상)
* `[CRLDistributionPoint]`: 발급하는 인증서에 `CDP 섹션`을 추가합니다.
* `[AuthorityInformationAccess]`: 발급하는 인증서에 `AIA` 섹션을 추가합니다.
    * 위 2개의 섹션 추가는 경로도 지정할 수 있으며, 필요할 시 위 링크를 참조합니다.


<br>

## 2. Root CA 구성
![](./MD_Images/07_01001.jpg)
* Root CA는 Workgroup으로 위와 같이 설정합니다.

<br>

![](./MD_Images/07_01002.jpg)
* 서버 역할 관리자를 통하여 AD 인증 서비스를 설치합니다.

<br>

![](./MD_Images/07_01003.jpg)
* AD CA에 필요한 기능을 같이 추가합니다.

<br>

![](./MD_Images/07_01004.jpg)
* 다음으로 넘어갑니다.

<br>

![](./MD_Images/07_01005.jpg)
* AD CA가 되게 되면, 컴퓨터의 이름 및 도메인 가입 & 탈퇴가 불가능하게 됩니다.

<br>

![](./MD_Images/07_01006.jpg)
* AD CA 서비스 중, 인증기관 역할만을 선택하여 설치합니다.

<br>

![](./MD_Images/07_01007.jpg)
* 설치를 진행합니다.

<br>

![](./MD_Images/07_01008.jpg)
* 설치가 끝나게 되면, AD CS를 구성합니다.

<br>

![](./MD_Images/07_01009.jpg)
* Root CA이기 때문에, 로컬 서버의 Admin 계정으로 자격 증명을 실행합니다.

<br>

![](./MD_Images/07_01010.jpg)
* 인증 기관을 선택 활성화합니다.

<br>

![](./MD_Images/07_01011.jpg)
* Domain에 가입된 서버가 아니기 때문에, 독립 CA를 선택합니다.

<br>

![](./MD_Images/07_01012.jpg)
* 루트 CA를 선택합니다.

<br>

![](./MD_Images/07_01013.jpg)
* 신규 CA를 구축하기 때문에, 새 개인 키를 생성합니다.
* 이 때 생성하는 개인키 옵션은 AD CS가 설치된 후 `변경이 불가능`하여 매우 중요합니다.

<br>

![](./MD_Images/07_01014.jpg)
* 인증 내용을 해시로 만드는데 사용할 암호화 옵션을 선택합니다.
* _SHA256에 4096을 흔히 많이 사용합니다._

<br>

![](./MD_Images/07_01015.jpg)
* CA의 이름을 설정합니다.
* default 값은 `[서버 네임]-CA` 입니다. 

<br>

![](./MD_Images/07_01016.jpg)
* 발급한 인증성의 유효 기간을 설정합니다.
* 서버들이 발급받는 인증서에 비해서 ROOT CA인증서의 기간은 매우 길게 설정합니다. (약 5~20년 정도)
* 그 이유는 해당 CA는 Offline으로 전환될 예정이기 때문에 최대한 해당 서버를 독립적으로 관리하기 위해서입니다.

<br>

![](./MD_Images/07_01017.jpg)
* CA DB 위치를 지정합니다.

<br>

![](./MD_Images/07_01018.jpg)
* 모든 설정이 완료되었다면, CA를 구성합니다.

<br>

![](./MD_Images/07_01019.jpg)
* 구성에 성공하면 위와 같이 출력됩니다.

<br>

![](./MD_Images/07_01020.jpg)

<br>

## 3. Root CA CDP 및 AIA 설정
참고링크: [https://learn.microsoft.com/ko-kr/windows-server/networking/core-network-guide/cncg/server-certs/configure-the-cdp-and-aia-extensions-on-ca1](https://learn.microsoft.com/ko-kr/windows-server/networking/core-network-guide/cncg/server-certs/configure-the-cdp-and-aia-extensions-on-ca1)

![](./MD_Images/07_02001.jpg)
* Root CA의 속성으로 넘어갑니다.

<br>

![](./MD_Images/07_02002.jpg)
* Root CA의 속성을 살펴보면, 확장에서 CDP를 확인할 수 있습니다.
* CDP는 CRL(인증서 해지 목록)이 있는 배포 지점으로, Root CA는 오프라인에 들어갈 예정이기 때문에 하위 CA 경로로 CDP를 추가합니다.

<br>

![](./MD_Images/07_02003.jpg)
```py
# 입력 경로
http://LSHCA-01.LSHCorp.com/CertData/<CaName><CRLNameSuffix><DeltaCRLAllowed>.crl

# 형식
http://[접속 경로]/<CaName><CRLNameSuffix><DeltaCRLAllowed>.crl
```
* 위 경로 형식을 참고하여, 경로를 입력합니다.

<br>

![](./MD_Images/07_02004.jpg)
1. 새로 추가한 경로 이외에 모든 경로를 삭제합니다.
    * "C:\Windows\system32\CertSrv\CertEnroll\<CaName><CRLNameSuffix><DeltaCRLAllowed>.crl" 는 삭제하지 않습니다.
2. CRL 파일을 요약본인 델타 CRL도 활성화합니다.
3. Root CA에서 발급된 인증서에 CDP 속성이 들어가게 합니다.
4. 설정한 내용을 적용합니다.

<br>

![](./MD_Images/07_02005.jpg)
* 적용 시에는 재시작이 필요하지만, AIA도 적용 후에 재시작하기 위하여 "아니오"를 선택합니다.

<br>

![](./MD_Images/07_02006.jpg)
* 확장 선택에서 AIA로 변경 후, 새로운 AIA를 추가합니다.
* AIA는 클라이언트가 CA 인증서가 없을 경우에 배포 받는 지점입니다.

<br>

![](./MD_Images/07_02007.jpg)
```py
# 입력 경로
http://LSHCA-01.LSHCorp.com/CertData/<ServerDNSName>_<CaName><CertificateName>.crt

# 형식
http://[접속경로]/<ServerDNSName>_<CaName><CertificateName>.crt
```

<br>

![](./MD_Images/07_02008.jpg)
1. 새로 추가한 AIA 이외의 AIA 경로는 전부 삭제합니다.
    * "C:\Windows\system32\CertSrv\CertEnroll\<ServerDNSName>_<CaName><CertificateName>.crt"는 삭제하지 않습니다.
2. Root CA가 발급한 인증서에 AIA 경로를 넣는 것을 활성화 합니다.
3. 모든 설정을 적용합니다.

<br>

![](./MD_Images/07_02009.jpg)
* AD CS를 재시작합니다. (_서버가 재부팅 되지는 않습니다._)

<br>

![](./MD_Images/07_02010.jpg)
* CDP와 AIA를 변경하였음으로 AD CS에 이 내용을 게시합니다.

<br>

![](./MD_Images/07_02011.jpg)
* 이를 통하여 새로운 CRL을 반영합니다.

<br>

![](./MD_Images/07_02012.jpg)
* 생성된 __CRL 파일__(인증서 해지 목록)과 __CRT 파일__(Root CA Self-signed 인증서)은 `C:\Windows\system32\CertSrv\CertEnroll\`에 생성 및 갱신됩니다.
* 위와 같이 게시할 경우, 기존 crl파일이 새롭게 수정됩니다.

<br>

![](./MD_Images/07_02013.jpg)
* 이제는 클라이언트 및 멤버 서버들에 배포한 PKI용 Root CA 인증서를 내보낼 차례입니다.
* Root CA의 속성으로 이동합니다.

<br>

![](./MD_Images/07_02014.jpg)
* __인증서 보기__ 를 클릭합니다. 

<br>

![](./MD_Images/07_02015.jpg)
* 자세히 탭으로 이동합니다.

<br>

![](./MD_Images/07_02016.jpg)
* Self-signed 인증서를 복사하기 위하여 __파일에 복사__ 를 클릭합니다.

<br>

![](./MD_Images/07_02017.jpg)
* 다음으로 넘어갑니다.

<br>

![](./MD_Images/07_02018.jpg)
* DER로 인코딩 된 바이너리 X.509 파일로 내보냅니다.

<br>

![](./MD_Images/07_02019.jpg)
* Root CA 인증서를 저장할 경로 및 이름을 설정합니다.
* 클라이언트에게 저장할 인증서로 나타내기 위하여 기존 crt 파일과 다른 이름으로 저장합니다.
    * 해당 파일의 포멧형식은 `cer`입니다.

<br>

![](./MD_Images/07_02020.jpg)
* Root CA 인증서를 저장합니다.

<br>

![](./MD_Images/07_02021.jpg)
* 다음으로 넘어갑니다.

<br>

![](./MD_Images/07_02022.jpg)
* 생성한 인증서들을 복사하여, 새로운 폴더에 복사한 파일들을 생성합니다.

하위 CA 설정은 다음 문서(Winodws CA Demo_2)에서 설명합니다.


<br>

>> 각각의 인증서 및 파일에 대한 부연설명을 하자면 조금씩 다릅니다.
>>>> `crl파일`: 인증서가 이미 해지가 되었는 확인할 수 있는 해지목록입니다.  
>>>> `crt파일`: 인증서 체인 구성에 사용되는 인증서 파일로, 서버나 클라이언트에서 실제 체인을 검증할 때 사용합니다.  
>>>> `cer파일`: Windows Client 환경에서 인증서를 설치하거나 브라우저/OS가 신뢰하도록 등록할 때 사용하는 파일입니다.  
>>>>>>> cer 파일에 대하여 crt와 비교하자면 인증 체인용이 아닌 `클라이언트 신뢰저장소 등록용 파일`입니다.



## 4. DNS(AD DC)에 Root CA 정보 추가

![](./MD_Images/07_02023.jpg)
* DNS에서 새로운 호스트에 Root CA를 추가합니다.

![](./MD_Images/07_02024.jpg)

<br>

## 5. 내용 정리
1. CAPolicy.inf를 설정하여 기본 RootCA 환경을 편집합니다.
2. AD CS를 설치하여 Root CA로 설정합니다.
3. Root CA는 추후에 오프라인 서버로 전환하기 때문에 CDP와 AIA URL을 아직 생성하지 않은 하위 CA로 설정합니다.
4. 내부 DNS에서 Root CA에 대한 정보를 모르기 때문에 DNS(AD DC)에 서버명을 추가합니다.
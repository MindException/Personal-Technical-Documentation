# RRAS(Routing and Remote Access Service) with Site-to-Site VPN

해당 문서에서는 Site와 Site를 서로 VPN으로 묶는 방법에 대해서 설명할 예정입니다.  
Azure에서는 Virtual Network Gateway를 사용하여 VPN을 형성하지만, On-premise에서는 장비 단에서 IKEv2 프로토콜을 사용하여 통신하게 됩니다.  
하지만 장비가 없을 경우, 소프트웨어적으로 구현할 수 있게 RRAS를 사용하여 구현할 예정입니다.

![](./MD_Images/18_00001.jpg)

</br>

# 목차

[1. Hop 서버 설정](#1-hop-서버-설정)  
[2. RRAS 설치 - Corp A](#2-corp-a-rras-역할-설치-및-설정)  
[3. RRAS 설치 - Corp B](#3-corp-b-rras-역할-설치-및-설정)  
[4. Client 접속 확인](#4-client-접속-확인-a-to-b)

</br>

## 1. Hop 서버 설정

#### 1. IP 설정
![](./MD_Images/18_01001.jpg)
```
ipconfig | Select-String "IPv4"
```


#### 2. 라우팅 기능 On
![](./MD_Images/18_01002.jpg)
```
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters" /v IPEnableRouter /t REG_DWORD /d 1 /f
```
* 위 레지스트리를 변경한 후에 시스템을 재부팅합니다.
* 다른 목적지로 가는 패킷을 중계할 수 있게 라우팅 기능을 활성화합니다.

_RRAS를 설치하기 전, 양쪽 RRAS 서버에서 Ping으로 Hop과 통신 가능한지 확인합니다._

</br>

## 2. Corp A RRAS 역할 설치 및 설정

#### 1. IP 설정
![](./MD_Images/18_02001.jpg)
```
ipconfig | Select-String "IPv4"
```
<br>

#### 2. 라우팅 테이블 설정
```
route -p add 196.0.0.0 mask 255.255.255.0 10.0.0.222 metric 50
route -p add 172.0.0.80 mask 255.255.255.0 10.0.0.222 metric 50
```
* Corp B의 외부 망인 `172.0.0.80` IP와 내부망인 `196.0.0.0` 서브넷을 갈 경우, `10.0.0.222` 게이트웨이를 사용할 수 있게 설정합니다.
* [(주의)](#주의-메트릭-값) 메트릭(=네트워크 우선순위)을 이후에 나오는 VPN 메트릭보다 작게 주면 안됩니다. (_아래에서 설명_)
* _양 쪽 RRAS의 Ping 작업은 각각 라우팅 테이블 설정이 완료되면 가능합니다._

<br>

#### 3. 방화벽 추가
![](./MD_Images/18_02002.jpg)
* TCP 443과 UDP 500 & 4500 Port를 개방합니다.

<br>

#### 4. RRAS 역할 설치
![](./MD_Images/18_02003.jpg)
* `원격 엑세스` 역할을 설치합니다.

<br>

![](./MD_Images/18_02004.jpg)
* `DirectAccess 및 VPN(RAS)`와 `라우팅` 서비스를 설치합니다.

</br>

![](./MD_Images/18_02009.jpg)
* `원격 엑세스` 시작 마법사 열기를 클릭합니다.

</br>

![](./MD_Images/18_02010.jpg)
* 서버명을 우 클릭한 후, `라우팅 및 원격 엑세스 구성 및 사용`을 클릭합니다.

</br>

![](./MD_Images/18_02011.jpg)
* `두 개의 개인 네트워크 사이의 보안 연결` 옵션을 선택합니다.

</br>

![](./MD_Images/18_02012.jpg)
* 이후에 설정할 예정으로 `아니요`를 선택합니다.

</br>

![](./MD_Images/18_02013.jpg)
* S2S 역할 설치를 완료합니다.

</br>

![](./MD_Images/18_02014.jpg)
* 활성화된 네트워크 인터페이스를 우 클릭한 후, `새 필요 시 전화 접속 인터페이스`를 클릭합니다.

</br>

![](./MD_Images/18_02015.jpg)
* 인터페이스 이름(= VPN) 이름을 설정합니다.

</br>

![](./MD_Images/18_02016.jpg)
* `VPN` 옵션을 선택합니다.

</br>

![](./MD_Images/18_02017.jpg)
* `IKEv2` 옵션을 선택합니다.

</br>

![](./MD_Images/18_02018.jpg)
* 반대 쪽 RRAS IP를 입력합니다.
* Azure와 VPN S2S 구성이었다면 Azure VPN Gateway IP를 입력하여 주면 됩니다.

</br>

![](./MD_Images/18_02019.jpg)
* `이 인터페이스에 IP 패킷을 라우트` 옵션만 선택합니다.

</br>

![](./MD_Images/18_02020.jpg)
* Corp B의 서브넷 대역대와 게이트웨이 우선순위를 위한 매트릭 값을 입력합니다.

</br>

![](./MD_Images/18_02021.jpg)
* Corp B 내부망 서브넷이 정상적으로 추가되면 다음으로 넘어갑니다.

</br>

![](./MD_Images/18_02022.jpg)
* 키 값(=비밀번호)을 통하여 통신할 예정으로 다음으로 넘어갑니다.

</br>

![](./MD_Images/18_02023.jpg)
* VPN 옵션 설정을 완료합니다.

</br>

![](./MD_Images/18_02024.jpg)
* 이전에 생성한 VPN 명을 우 클릭하여 속성을 클릭합니다.

</br>

![](./MD_Images/18_02025.jpg)
* `보안` 탭에서 키 사용 옵션을 체크한 후에 키 값(=비밀번호)를 입력합니다.

</br>

## 3. Corp B RRAS 역할 설치 및 설정
_2번 목차와 겹치는 부분은 생략합니다._

#### 1. IP 설정
![](./MD_Images/18_03001.jpg)
```
ipconfig | Select-String "IPv4"
```
<br>

#### 2. 라우팅 테이블 설정
```
route -p add 192.0.0.0 mask 255.255.255.0 172.0.0.222 metric 50
route -p add 10.0.0.70 mask 255.255.255.0 172.0.0.222 metric 50
```
* Corp B의 외부 망인 `10.0.0.70` IP와 내부망인 `192.0.0.0` 서브넷을 갈 경우, `172.0.0.222` 게이트웨이를 사용할 수 있게 설정합니다.


#### 3. 방화벽 설정
![](./MD_Images/18_02002.jpg)
* TCP 443과 UDP 500 & 4500 Port를 개방합니다.


#### 4. RRAS 역할 설치

\- 원격 엑세스 역할 설치는 생략합니다. -  

![](./MD_Images/18_03002.jpg)
* 연결할 Corp A RRAS IP를 입력합니다.

<br>

![](./MD_Images/18_03003.jpg)
* 연결할 Corp A 내부망 서브넷을 입력합니다.

<br>

![](./MD_Images/18_03004.jpg)
* 마지막으로 Corp A RRAS에서 입려하였던 키 값과 동일한 키 값을 입력합니다.

<br>

|  |  |
|:---:|:---:|
| AS-IS | ![](./MD_Images/18_03005.jpg) |
| TO-BE | ![](./MD_Images/18_03006.jpg) |
* _연결이 바로 안 될 경우, VPN 명을 우 클릭한 후에 연결을 클릭합니다._

<br>

#### [주의] 메트릭 값
![](./MD_Images/18_03007.jpg)
* VPN이 서로 연결이 되고 난 후에는 터널이 생성되게 되며, 터널끼리만 사용하는 IP가 생성되게 됩니다.
* 이전에 얘기한 Hop으로 보내는 메트릭 값을 작게 주게 안 되는 사유는 VPN보다 Hop으로 보내는 라우팅 값이 우선순위가 되면서 VPN을 사용하지 않게 됩니다.
* 이후에는 VPN이 아닌 Hop은 이러한 상황을 모르기 때문에 Hop에서 패킷이 누락되게 됩니다.
* 따라서 Hop으로 보내는 게이트웨이 메트릭 값이 VPN 메트릭 값보다 커야 합니다.(= `VPN 네트워크가 우선순위가 더 높다.`)


## 4. Client 접속 확인 (A to B)

![](./MD_Images/18_00001.jpg)  
ClientSvr01에서 ClientSvr02의 설치된 IIS 접속에 성공하는 것으로 Demo를 마칩니다.

#### 1. IP & Gateway 설정

| ClientSvr01 | ClientSvr02 |
|:---:|:---:|
|![](./MD_Images/18_04001.jpg)|![](./MD_Images/18_04002.jpg) |

* 위와 같이 RRAS 서버들을 게이트웨이로 설정합니다.

#### 2. 결과
![](./MD_Images/18_04003.jpg)
* 위와 같이 정상적으로 Corp A에서 Corp B의 IIS에 접속하는 모습을 확인할 수 있습니다.